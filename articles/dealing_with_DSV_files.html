<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Dealing with DSV files • RSQLite.toolkit</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Dealing with DSV files">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">RSQLite.toolkit</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/dealing_with_DSV_files.html">Dealing with DSV files</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/fab-algo/RSQLite.toolkit/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Dealing with DSV files</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/fab-algo/RSQLite.toolkit/blob/master/vignettes/dealing_with_DSV_files.Rmd" class="external-link"><code>vignettes/dealing_with_DSV_files.Rmd</code></a></small>
      <div class="d-none name"><code>dealing_with_DSV_files.Rmd</code></div>
    </div>

    
    
<p>“Delimiter-separated values” (DSV) files are (unfortunately) still a
very common way to serialize tabular data and are widely used as a data
exchange format. Since there isn’t a strict technical standard that
specifies how different data types should be represented in plain text,
and a lot of possible customizations are left to the final users, it is
very common to encounter issues when data is imported from this kind of
files. The purpose of this article is to show some problems you can
encounter loading data in a SQLite database from DSV files and how to
deal with them.</p>
<div class="section level2">
<h2 id="data-interpretation-issues">Data interpretation issues<a class="anchor" aria-label="anchor" href="#data-interpretation-issues"></a>
</h2>
<p>When dealing with DSV files, one of the most common sources of issues
is the way data is represented in the file. Since DSV files are plain
text files, there are many conventions that can be used to represent
different data types (e.g., strings, numbers, dates, missing data,
etc.).</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/fab-algo/RSQLite.toolkit" class="external-link">RSQLite.toolkit</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: RSQLite</span></span></code></pre></div>
<p>Let’s start with a simple example using real-world data. To retrieve
some example files, we can use the package <a href="https://github.com/ropensci/piggyback" class="external-link">piggyback</a> to download
public datasets that have been stored in the <a href="https://github.com/fab-algo/RSQLite.toolkit-tests" class="external-link">RSQLite.toolkit-tests</a>
GitHub repository<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;The original source of each dataset is described in the
README page of the GitHub repo.&lt;/p&gt;"><sup>1</sup></a>.</p>
<p>The first example will deal with a table contained in a “standard”
CSV file (i.e. a text file with the first line containing column names,
using the comma to separate fields’ values and the dot as a decimal
separator for numbers); we will load the data in a new table inside a
SQLite database using the <code><a href="../reference/dbTableFromDSV.html">dbTableFromDSV()</a></code> function.</p>
<p>First, we download the data from the repo:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://docs.ropensci.org/piggyback" class="external-link">"piggyback"</a></span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://docs.ropensci.org/piggyback/reference/pb_download.html" class="external-link">pb_download</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">"DOSE_V2.10.zip"</span>, dest <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            repo <span class="op">=</span> <span class="st">"fab-algo/RSQLite.toolkit-tests"</span>, tag <span class="op">=</span> <span class="st">"latest"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/unzip.html" class="external-link">unzip</a></span><span class="op">(</span>zipfile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"DOSE_V2.10.zip"</span><span class="op">)</span>, exdir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"DOSE_V2.10"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "DOSE_V2.10.csv"        "DoseV2p10_changes.pdf"</span></span>
<span></span>
<span><span class="va">data_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"DOSE_V2.10/DOSE_V2.10.csv"</span><span class="op">)</span></span></code></pre></div>
<p>After unzipping the downloaded file, we get the
<code>DOSE_V2.10.csv</code> file that contains the dataset we are
interested in. We can now check the number of rows in the input
file:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_rows</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/count.fields.html" class="external-link">count.fields</a></span><span class="op">(</span><span class="va">data_file</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">n_rows</span></span>
<span><span class="co">#&gt; [1] 46852</span></span></code></pre></div>
<p>So we expect to have 46851 records in the SQLite table at the end of
the import process. Now we connect to a sample database
(i.e. <code>tests.sqlite</code>):</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dbcon</span> <span class="op">&lt;-</span> <span class="fu">dbConnect</span><span class="op">(</span><span class="fu">RSQLite</span><span class="fu">::</span><span class="fu"><a href="https://rsqlite.r-dbi.org/reference/SQLite.html" class="external-link">SQLite</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"tests.sqlite"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>and move the dataset in a table there, calling the
<code><a href="../reference/dbTableFromDSV.html">dbTableFromDSV()</a></code> function specifying the connection to the
database (i.e., <code>dbcon</code> parameter) and the table name (i.e.,
<code>table_name</code> parameter). We don’t need to specify the
parameters for the CSV file structure (i.e., <code>header = TRUE</code>,
<code>sep = ","</code>, <code>dec = "."</code>, <code>grp = ""</code>)
since the default values will be fine.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## do not run: error</span></span>
<span><span class="fu"><a href="../reference/dbTableFromDSV.html">dbTableFromDSV</a></span><span class="op">(</span>input_file <span class="op">=</span> <span class="va">data_file</span>, dbcon <span class="op">=</span> <span class="va">dbcon</span>, table_name <span class="op">=</span> <span class="st">"DOSE"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;">:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> Blocking error in dbTableFromDSV while reading data from input file.</span></span>
<span><span class="co">#&gt; Original error msg: scan() expected 'an integer', got 'GRC.7_1'</span></span></code></pre></div>
<p>To understand what happened we need to keep in mind that the
<code><a href="../reference/dbTableFromDSV.html">dbTableFromDSV()</a></code> function calls
<em><code>file_schema_dsv</code></em> function, to guess the table
structure stored in the DSV file, and then it calls the
<em><code>scan</code></em> function to actually read the file content in
a data frame and write it to the SQLite table.</p>
<p>Both these functions make some assumptions about how the data is
stored in the DSV file as “plain text”. To that end, the
<code>scan</code> function uses the parameters listed in the following
table along with their default values (we inclued also those of the
<code>read.table</code> function for comparison):</p>
<table class="table">
<caption>
<code>scan</code> and <code>read.table</code> parameters to
handle data interpretation.</caption>
<thead><tr class="header">
<th>parameters</th>
<th><em>scan</em></th>
<th>read.table</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>quote</td>
<td><code>"'\""</code></td>
<td><code>"\"'"</code></td>
</tr>
<tr class="even">
<td>allowEscapes</td>
<td><code>FALSE</code></td>
<td><code>FALSE</code></td>
</tr>
<tr class="odd">
<td>skipNul</td>
<td><code>FALSE</code></td>
<td><code>FALSE</code></td>
</tr>
<tr class="even">
<td>strip.white</td>
<td><code>FALSE</code></td>
<td><code>FALSE</code></td>
</tr>
<tr class="odd">
<td>comment.char</td>
<td><code>""</code></td>
<td><code>"#"</code></td>
</tr>
<tr class="even">
<td>na.strings</td>
<td><code>"NA"</code></td>
<td><code>"NA"</code></td>
</tr>
<tr class="odd">
<td>fill</td>
<td><code>FALSE</code></td>
<td><code>FALSE</code></td>
</tr>
<tr class="even">
<td>fileEncoding</td>
<td><code>""</code></td>
<td><code>""</code></td>
</tr>
</tbody>
</table>
<p>These parameters control the conventions used to interpret the text
read from the file:</p>
<ul>
<li>
<em>quoting</em>: convention used to include in strings “special”
characters or to preserve the exact string without interpretation.
Parameter: <code>quote</code>
</li>
<li>
<em>escaping</em>: rule used to represent characters that would
otherwise be interpreted as delimiters or special commands. Parameter:
<code>allowEscapes</code>
</li>
<li>
<em>NUL characters</em>: how to manage ASCII NUL characters that
could be found inside strings. Parameter: <code>skipNul</code>
</li>
<li>
<em>whitespace stripping</em>: whether unwanted spaces from the
beginning, end, or middle of a string should be removed. Parameter:
<code>strip.white</code>
</li>
<li>
<em>commenting</em>: a character used to identify that one line (or
the rest of a line after the “comment” identifier) does not contain data
and should be ignored. Parameter: <code>comment.char</code>
</li>
<li>
<em>missing data</em>: how missing data is represented in the file.
Parameter: <code>na.strings</code>
</li>
<li>
<em>missing fields</em>: how to manage rows with less fields then
expected. Parameter: <code>fill</code>
</li>
<li>
<em>encoding</em>: the technical standard used to represent
characters in binary form, such as ASCII, UTF-8, EBCDIC. Parameter:
<code>fileEncoding</code>
</li>
</ul>
<p>To understand how to use each of these parameters you are strongly
encouraged to read the help pages of the <code>scan</code> function.</p>
<p>It should be noted that the default values are seldom—almost
never—the right ones and we should invest some time in better
understanding the strategies used by the data source. If we have a
technical description of the assumptions used in creating the file, we
can follow those guidelines, otherwise we have to inspect the file and
determine them through direct examination.</p>
<p>To look into a DSV file (especially big files) it is better to use
log file explorers and avoid general purpose text editors. As an
example, we can use <a href="https://klogg.filimonov.dev/" class="external-link">klogg</a>
that is available for all major operating systems.</p>
<p>If we open the file and inspect some records, we understand that:</p>
<ul>
<li>there are strings with comma and single quote inside, surrounded by
double quotes, so the file is using a specific quoting convention;</li>
<li>missing data is represented by a “zero-lenght” string;</li>
<li>many strings use special characters that need a specific encoding
system; in this file the UTF-8 encoding is used.</li>
</ul>
<p>For the input file used in this example we need:</p>
<ul>
<li>to explicitly force the <code>quote</code> parameter to
<code>"\""</code> (i.e., only the double quote character) and the
<code>na.strings</code> parameter to <code>""</code>;</li>
<li>to turn off the commenting option:
<code>comment.char = ""</code>;</li>
<li>to tell the <code><a href="https://rdrr.io/r/base/scan.html" class="external-link">base::scan()</a></code> function that the input file
is encoded in UTF-8: <code>fileEncoding = "UTF-8"</code>.</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f_schema1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/file_schema_dsv.html">file_schema_dsv</a></span><span class="op">(</span>input_file <span class="op">=</span> <span class="va">data_file</span>,</span>
<span>                             quote <span class="op">=</span> <span class="st">"\""</span>, na.strings <span class="op">=</span> <span class="st">""</span>,</span>
<span>                             comment.char <span class="op">=</span> <span class="st">""</span>, fileEncoding <span class="op">=</span> <span class="st">"UTF-8"</span><span class="op">)</span></span></code></pre></div>
<p>Now we can see that the guessed schema is correct. Let’s look at the
first few rows of the file schema created using these parameters:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f_schema1</span><span class="op">$</span><span class="va">schema</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">8</span>, <span class="op">]</span></span>
<span><span class="co">#&gt;    col_names col_names_unquoted col_types sql_types  src_names src_types</span></span>
<span><span class="co">#&gt; 1    country            country character      TEXT    country      text</span></span>
<span><span class="co">#&gt; 2     region             region character      TEXT     region      text</span></span>
<span><span class="co">#&gt; 3      GID_0              GID_0 character      TEXT      GID_0      text</span></span>
<span><span class="co">#&gt; 4      GID_1              GID_1 character      TEXT      GID_1      text</span></span>
<span><span class="co">#&gt; 5     F_year             F_year   integer   INTEGER       year      text</span></span>
<span><span class="co">#&gt; 6    grp_lcu            grp_lcu   numeric      REAL    grp_lcu      text</span></span>
<span><span class="co">#&gt; 7        pop                pop   numeric      REAL        pop      text</span></span>
<span><span class="co">#&gt; 8 grp_pc_lcu         grp_pc_lcu   numeric      REAL grp_pc_lcu      text</span></span>
<span><span class="co">#&gt;   src_is_quoted</span></span>
<span><span class="co">#&gt; 1         FALSE</span></span>
<span><span class="co">#&gt; 2         FALSE</span></span>
<span><span class="co">#&gt; 3         FALSE</span></span>
<span><span class="co">#&gt; 4         FALSE</span></span>
<span><span class="co">#&gt; 5         FALSE</span></span>
<span><span class="co">#&gt; 6         FALSE</span></span>
<span><span class="co">#&gt; 7         FALSE</span></span>
<span><span class="co">#&gt; 8         FALSE</span></span></code></pre></div>
<p>The <code><a href="../reference/file_schema_dsv.html">file_schema_dsv()</a></code> function returns a list with many
useful information about the input file, including the
<code>schema</code> data frame that describes the columns found in the
file (i.e. name, type, size, etc.). For more details about it, please
refer to its documentation. One point to note is that the
<code>year</code> column has been modified to <code>F_year</code> since
<code>year</code> is a reserved keyword in SQLite. That’s the default
behavior of the <code><a href="../reference/dbTableFromDSV.html">dbTableFromDSV()</a></code> function when dealing with
column names (see next section for more details).</p>
<p>Now we can re-run the <code><a href="../reference/dbTableFromDSV.html">dbTableFromDSV()</a></code> function
specifying the correct parameters to interpret the data in the input
file:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dbTableFromDSV.html">dbTableFromDSV</a></span><span class="op">(</span>input_file <span class="op">=</span> <span class="va">data_file</span>, dbcon <span class="op">=</span> <span class="va">dbcon</span>, table_name <span class="op">=</span> <span class="st">"DOSE"</span>,</span>
<span>               drop_table <span class="op">=</span> <span class="cn">TRUE</span>, quote <span class="op">=</span> <span class="st">"\""</span>, na.strings <span class="op">=</span> <span class="st">""</span>,</span>
<span>               comment.char <span class="op">=</span> <span class="st">""</span>, fileEncoding <span class="op">=</span> <span class="st">"UTF-8"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 46851</span></span></code></pre></div>
<p>As we can see now we got all the expected records in the SQLite
table. We can check that by listing the tables in the database, the
fields in the <code>DOSE</code> table and counting the number of records
in it:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dbListTables</span><span class="op">(</span><span class="va">dbcon</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "DOSE"</span></span>
<span></span>
<span><span class="fu">dbListFields</span><span class="op">(</span><span class="va">dbcon</span>, <span class="st">"DOSE"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">8</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] "country"    "region"     "GID_0"      "GID_1"      "F_year"    </span></span>
<span><span class="co">#&gt; [6] "grp_lcu"    "pop"        "grp_pc_lcu"</span></span>
<span></span>
<span><span class="fu">dbGetQuery</span><span class="op">(</span><span class="va">dbcon</span>, <span class="st">"SELECT COUNT(*) AS n_records FROM DOSE"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   n_records</span></span>
<span><span class="co">#&gt; 1     46851</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="issues-with-column-names">Issues with column names<a class="anchor" aria-label="anchor" href="#issues-with-column-names"></a>
</h2>
<p>Unfortunately, when dealing with DSV files, problems are not limited
to data interpretation only. Another common source of issues are the
column names used in the input file.</p>
<p>While DSV files may contain column headers that are valid in their
original context (such as Excel or other applications), these names
might not conform to SQLite’s naming conventions or best practices.</p>
<p>SQLite has specific rules and restrictions regarding column names,
including:</p>
<ul>
<li>Must begin with a letter (A-Z, a-z) or an underscore (_)</li>
<li>Can contain letters, digits (0-9), and underscores (_)</li>
<li>Cannot be a reserved keyword in SQLite</li>
<li>Should avoid special characters and spaces for better
compatibility</li>
</ul>
<p>You can find more details about SQLite’s naming conventions in the <a href="https://www.sqlite.org/lang_keywords.html" class="external-link">official
documentation</a> and <a href="https://www.sqlite.org/lang_createtable.html" class="external-link">CREATE TABLE</a>
page. There are also some interesting discussions on Stack Overflow:</p>
<ul>
<li><a href="https://stackoverflow.com/questions/3694276/what-are-valid-table-names-in-sqlite" class="external-link">What
are valid table names in SQLite?</a></li>
<li><a href="https://stackoverflow.com/questions/3373234/what-sqlite-column-name-can-be-cannot-be" class="external-link">What
SQLite column name can be/cannot be?</a></li>
<li><a href="https://stackoverflow.com/questions/23770480/sqlite-table-and-column-name-requirements" class="external-link">SQLite
table and column name requirements</a></li>
</ul>
<p>Some typical problems you might encounter include:</p>
<ul>
<li>
<em>Special characters</em>: Column names containing spaces,
hyphens, or other special characters (e.g., <code>"Patient-ID"</code>,
<code>"Test Result"</code>, <code>"Cost($)"</code>);</li>
<li>
<em>Reserved keywords</em>: Column names that match SQLite reserved
words (e.g., <code>"SELECT"</code>, <code>"TABLE"</code>,
<code>"WHERE"</code>);</li>
<li>
<em>Starting with numbers</em>: Column names beginning with digits
(e.g., <code>"2025_Sales"</code>);</li>
<li>
<em>Case sensitivity</em>: While SQLite is case-insensitive for
column names, mixing cases can lead to confusion;</li>
<li>
<em>Empty or duplicate names</em>: Missing headers or columns with
identical names.</li>
</ul>
<p>You should always inspect the column names in your DSV files before
importing them into a SQLite database to ensure they meet these
criteria. Failing to do so can lead to errors during the import process
or unexpected behavior when querying the database.</p>
<div class="section level3">
<h3 id="how-rsqlite-toolkit-handles-column-names">How RSQLite.toolkit handles column names<a class="anchor" aria-label="anchor" href="#how-rsqlite-toolkit-handles-column-names"></a>
</h3>
<p>The <code><a href="../reference/dbTableFromDSV.html">dbTableFromDSV()</a></code> function<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;The same mechanism to handle column names is used also
by the &lt;code&gt;&lt;a href="../reference/dbTableFromXlsx.html"&gt;dbTableFromXlsx()&lt;/a&gt;&lt;/code&gt;, &lt;code&gt;&lt;a href="../reference/dbTableFromFeather.html"&gt;dbTableFromFeather()&lt;/a&gt;&lt;/code&gt;
and &lt;code&gt;&lt;a href="../reference/dbTableFromDataFrame.html"&gt;dbTableFromDataFrame()&lt;/a&gt;&lt;/code&gt; functions.&lt;/p&gt;'><sup>2</sup></a> offers a built-in
mechanism to handle problematic column names when importing data from
DSV files. It does so through the <code>id_quote_method</code> parameter
that can be set to one of the following values:</p>
<ul>
<li>
<code>DB_NAMES</code> tries to build a valid SQLite column name:
<ol style="list-style-type: lower-alpha">
<li>substituting all characters, that are not letters or digits or the
<code>_</code> character, with the <code>_</code> character;</li>
<li>prefixing <code>N_</code> to all strings starting with a digit;</li>
<li>prefixing <code>F_</code> to all strings equal to any SQL92
keyword.</li>
</ol>
</li>
<li>
<code>SINGLE_QUOTES</code> encloses each string in single
quotes.</li>
<li>
<code>SQL_SERVER</code> encloses each string in square
brackets.</li>
<li>
<code>MYSQL</code> encloses each string in back ticks.</li>
</ul>
<p>The default value is <code>DB_NAMES</code>.</p>
<p>What actually happens is that to ensure valid and unique column
names, the <code><a href="../reference/dbTableFromDSV.html">dbTableFromDSV()</a></code> function calls the
<code><a href="../reference/file_schema_dsv.html">file_schema_dsv()</a></code> function that in turn calls the
<code><a href="../reference/format_column_names.html">format_column_names()</a></code> function, passing to it the column
names read from the DSV file, the selected <code>id_quote_method</code>
and the <code>unique_names = TRUE</code> parameter, to ensure that all
column names are unique.</p>
<p>If you are not satisfied with the way column names are handled, you
can always manually specify the column names to be used in the SQLite
table using the <code>col_names</code> parameter of the
<code><a href="../reference/dbTableFromDSV.html">dbTableFromDSV()</a></code> function.</p>
</div>
<div class="section level3">
<h3 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h3>
<p>Let’s create a simple example to demonstrate this behavior; we will
use a DSV file with problematic column names that we will download from
the <a href="https://github.com/fab-algo/RSQLite.toolkit-tests" class="external-link">RSQLite.toolkit-tests</a>
repository.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://docs.ropensci.org/piggyback" class="external-link">"piggyback"</a></span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://docs.ropensci.org/piggyback/reference/pb_download.html" class="external-link">pb_download</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">"Blockchain_Banking_Scopus_Dataset_2015_2025.zip"</span>,</span>
<span>            dest <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, repo <span class="op">=</span> <span class="st">"fab-algo/RSQLite.toolkit-tests"</span>,</span>
<span>            tag <span class="op">=</span> <span class="st">"latest"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/unzip.html" class="external-link">unzip</a></span><span class="op">(</span>zipfile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                          <span class="st">"Blockchain_Banking_Scopus_Dataset_2015_2025.zip"</span><span class="op">)</span>,</span>
<span>      exdir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"Blockchain"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"Blockchain"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Blockchain_Banking_Scopus_Dataset_2015_2025.csv"</span></span>
<span></span>
<span><span class="va">data_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                       <span class="st">"Blockchain/Blockchain_Banking_Scopus_Dataset_2015_2025.csv"</span><span class="op">)</span> <span class="co"># nolint</span></span></code></pre></div>
<p>Now we can inspect the column names used in the input file:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f_schema2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/file_schema_dsv.html">file_schema_dsv</a></span><span class="op">(</span>input_file <span class="op">=</span> <span class="va">data_file</span>,</span>
<span>                             quote <span class="op">=</span> <span class="st">"\""</span>, na.strings <span class="op">=</span> <span class="st">""</span>,</span>
<span>                             comment.char <span class="op">=</span> <span class="st">""</span>, fileEncoding <span class="op">=</span> <span class="st">"UTF-8"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">f_schema2</span><span class="op">$</span><span class="va">schema</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="op">]</span></span>
<span><span class="co">#&gt;            col_names col_names_unquoted col_types sql_types         src_names</span></span>
<span><span class="co">#&gt; 1            Authors            Authors character      TEXT           Authors</span></span>
<span><span class="co">#&gt; 2  Author_full_names  Author_full_names character      TEXT Author full names</span></span>
<span><span class="co">#&gt; 3        Author_s_ID        Author_s_ID character      TEXT      Author(s) ID</span></span>
<span><span class="co">#&gt; 4              Title              Title character      TEXT             Title</span></span>
<span><span class="co">#&gt; 5             F_Year             F_Year character      TEXT              Year</span></span>
<span><span class="co">#&gt; 6       Source_title       Source_title character      TEXT      Source title</span></span>
<span><span class="co">#&gt; 7             Volume             Volume character      TEXT            Volume</span></span>
<span><span class="co">#&gt; 8              Issue              Issue character      TEXT             Issue</span></span>
<span><span class="co">#&gt; 9            Art_No_            Art_No_ character      TEXT          Art. No.</span></span>
<span><span class="co">#&gt; 10        Page_start         Page_start character      TEXT        Page start</span></span>
<span><span class="co">#&gt;    src_types src_is_quoted</span></span>
<span><span class="co">#&gt; 1       text          TRUE</span></span>
<span><span class="co">#&gt; 2       text          TRUE</span></span>
<span><span class="co">#&gt; 3       text          TRUE</span></span>
<span><span class="co">#&gt; 4       text          TRUE</span></span>
<span><span class="co">#&gt; 5       text          TRUE</span></span>
<span><span class="co">#&gt; 6       text          TRUE</span></span>
<span><span class="co">#&gt; 7       text          TRUE</span></span>
<span><span class="co">#&gt; 8       text          TRUE</span></span>
<span><span class="co">#&gt; 9       text          TRUE</span></span>
<span><span class="co">#&gt; 10      text          TRUE</span></span></code></pre></div>
<p>The <code>src_names</code> column contains the original column names
found in the input file. As we can see, there are some problematic
column names, such as <code>Author(s) ID</code>,
<code>Document Title</code>, <code>Funding Text</code>,
<code>Art. No.</code>, etc.</p>
<p>The <code>col_names</code> column contains the transformed column
names using the <code>DB_NAMES</code> method (i.e., the default value
for the <code>id_quote_method</code> parameter). Comparing the two
columns, we can see how some characters have been replaced with the
<code>_</code> character, spaces have been replaced with <code>_</code>,
and some names have been prefixed with <code>F_</code> to avoid
conflicts with SQLite reserved keywords (e.g., <code>Year</code>).</p>
<p>Now let’s see how the column names are handled when using the
<code>SQL_SERVER</code> method:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f_schema2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/file_schema_dsv.html">file_schema_dsv</a></span><span class="op">(</span>input_file <span class="op">=</span> <span class="va">data_file</span>,</span>
<span>                             quote <span class="op">=</span> <span class="st">"\""</span>, na.strings <span class="op">=</span> <span class="st">""</span>,</span>
<span>                             id_quote_method <span class="op">=</span> <span class="st">"SQL_SERVER"</span>,</span>
<span>                             comment.char <span class="op">=</span> <span class="st">""</span>, fileEncoding <span class="op">=</span> <span class="st">"UTF-8"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">f_schema2</span><span class="op">$</span><span class="va">schema</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="op">]</span></span>
<span><span class="co">#&gt;              col_names col_names_unquoted col_types sql_types         src_names</span></span>
<span><span class="co">#&gt; 1            [Authors]            Authors character      TEXT           Authors</span></span>
<span><span class="co">#&gt; 2  [Author full names]  Author full names character      TEXT Author full names</span></span>
<span><span class="co">#&gt; 3       [Author(s) ID]       Author(s) ID character      TEXT      Author(s) ID</span></span>
<span><span class="co">#&gt; 4              [Title]              Title character      TEXT             Title</span></span>
<span><span class="co">#&gt; 5               [Year]               Year character      TEXT              Year</span></span>
<span><span class="co">#&gt; 6       [Source title]       Source title character      TEXT      Source title</span></span>
<span><span class="co">#&gt; 7             [Volume]             Volume character      TEXT            Volume</span></span>
<span><span class="co">#&gt; 8              [Issue]              Issue character      TEXT             Issue</span></span>
<span><span class="co">#&gt; 9           [Art. No.]           Art. No. character      TEXT          Art. No.</span></span>
<span><span class="co">#&gt; 10        [Page start]         Page start character      TEXT        Page start</span></span>
<span><span class="co">#&gt;    src_types src_is_quoted</span></span>
<span><span class="co">#&gt; 1       text          TRUE</span></span>
<span><span class="co">#&gt; 2       text          TRUE</span></span>
<span><span class="co">#&gt; 3       text          TRUE</span></span>
<span><span class="co">#&gt; 4       text          TRUE</span></span>
<span><span class="co">#&gt; 5       text          TRUE</span></span>
<span><span class="co">#&gt; 6       text          TRUE</span></span>
<span><span class="co">#&gt; 7       text          TRUE</span></span>
<span><span class="co">#&gt; 8       text          TRUE</span></span>
<span><span class="co">#&gt; 9       text          TRUE</span></span>
<span><span class="co">#&gt; 10      text          TRUE</span></span></code></pre></div>
<p>As we can see, now the column names have been enclosed in square
brackets (<code>[</code> and <code>]</code>) to make them valid SQLite
identifiers. This quoting convention allows the use of special
characters and spaces in column names without causing issues during
database operations. We can test that by creating a new table in the
database using this quoting method:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dbTableFromDSV.html">dbTableFromDSV</a></span><span class="op">(</span>input_file <span class="op">=</span> <span class="va">data_file</span>,</span>
<span>               dbcon <span class="op">=</span> <span class="va">dbcon</span>, table_name <span class="op">=</span> <span class="st">"BLOCKCHAIN_BANKING"</span>,</span>
<span>               quote <span class="op">=</span> <span class="st">"\""</span>, na.strings <span class="op">=</span> <span class="st">""</span>,</span>
<span>               comment.char <span class="op">=</span> <span class="st">""</span>, fileEncoding <span class="op">=</span> <span class="st">"UTF-8"</span>,</span>
<span>               id_quote_method <span class="op">=</span> <span class="st">"SQL_SERVER"</span>,</span>
<span>               drop_table <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 389</span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dbListTables</span><span class="op">(</span><span class="va">dbcon</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "BLOCKCHAIN_BANKING" "DOSE"</span></span>
<span></span>
<span><span class="fu">dbListFields</span><span class="op">(</span><span class="va">dbcon</span>, <span class="st">"BLOCKCHAIN_BANKING"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">8</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] "Authors"           "Author full names" "Author(s) ID"     </span></span>
<span><span class="co">#&gt; [4] "Title"             "Year"              "Source title"     </span></span>
<span><span class="co">#&gt; [7] "Volume"            "Issue"</span></span>
<span></span>
<span><span class="fu">dbGetQuery</span><span class="op">(</span><span class="va">dbcon</span>, <span class="st">"SELECT COUNT(*) AS n_records FROM BLOCKCHAIN_BANKING"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   n_records</span></span>
<span><span class="co">#&gt; 1       389</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu">dbDisconnect</span><span class="op">(</span><span class="va">dbcon</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="conclusions">Conclusions<a class="anchor" aria-label="anchor" href="#conclusions"></a>
</h2>
<p>To more safely handle DSV files (and avoid unexpected results) when
importing data in a SQLite database using the
<code><a href="../reference/dbTableFromDSV.html">dbTableFromDSV()</a></code> function, you should always:</p>
<ul>
<li>inspect the input file to understand how data is represented; to
that end, you can use the <code><a href="../reference/file_schema_dsv.html">file_schema_dsv()</a></code> function to
help you in this task and test different parameter settings before
importing the data;</li>
<li>specify the correct parameters to interpret data in the input file
(i.e. <code>quote</code>, <code>na.strings</code>,
<code>comment.char</code>, <code>fileEncoding</code>, etc.);</li>
<li>check the column names used in the input file and choose the right
strategy to handle them, here the <code>id_quote_method</code> parameter
of the <code><a href="../reference/dbTableFromDSV.html">dbTableFromDSV()</a></code> function can be very useful.</li>
</ul>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Ludovico G. Beretta.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
